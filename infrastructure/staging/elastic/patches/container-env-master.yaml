---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: es-master
  labels:
    app: "es-master"
spec:
  template:
    spec:
      containers:
      - name: "elasticsearch"
        env:
          - name: node.name
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: cluster.initial_master_nodes
            value: "es-master-0"
          - name: node.roles
            value: "master,data_hot,data_content"
          - name: node.attr.type
            value: "hot"
          - name: discovery.seed_hosts
            value: "es-master-headless"
          - name: cluster.name
            value: "logging"
          - name: network.host
            value: "0.0.0.0"
          - name: ELASTIC_PASSWORD
            valueFrom:
              secretKeyRef:
                name: es-master-credentials
                key: password
          # will prevent the virtual address space (on Linux distribution) to run into errors or exceptions 
          # because this default configuration is too low. 
          - name: node.store.allow_mmap
            value: "false"
          # Makes sure that Elasticsearch allocates primary and replica shards to pods running on different Kubernetes nodes 
          # and never to pods that are scheduled onto a single Kubernetes node
          #          - name: cluster.routing.allocation.awareness.attributes
          #            value: "k8s_node_name"
          # XPack security configuration
          - name: xpack.security.enabled
            value: "true"
          - name: xpack.security.transport.ssl.enabled
            value: "true"
          - name: xpack.security.transport.ssl.verification_mode
            value: "certificate"
          - name: xpack.security.transport.ssl.keystore.path
            value: "/usr/share/elasticsearch/config/certs/elastic-certificates.p12"
          - name: xpack.security.transport.ssl.truststore.path
            value: "/usr/share/elasticsearch/config/certs/elastic-certificates.p12"
          - name: xpack.security.http.ssl.enabled
            value: "true"
          - name: xpack.security.http.ssl.truststore.path
            value: "/usr/share/elasticsearch/config/certs/elastic-certificates.p12"
          - name: xpack.security.http.ssl.keystore.path
            value: "/usr/share/elasticsearch/config/certs/elastic-certificates.p12"
          # XPack - Monitoring configuration
          - name: xpack.monitoring.enabled 
            value: "true"
          - name: xpack.monitoring.collection.cluster.stats.timeout
            value: "10m"
          - name: xpack.monitoring.collection.index.recovery.active_only
            value: "false"
          - name: xpack.monitoring.collection.index.recovery.timeout
            value: "10m"
          - name: xpack.monitoring.collection.index.stats.timeout
            value: "10m"
          - name: xpack.monitoring.collection.indices
            value: "'*'"
          - name: xpack.monitoring.collection.interval
            value: "60s"
          - name: xpack.monitoring.history.duration
            value: "30d"