---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: thanos
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: thanos
      version: 12.8.5
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: true
    remediation:
      retries: 5

  upgrade:
    remediation:
      retries: 5

  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
#    - name: rook-ceph
#      namespace: rook-ceph

  values:
    query:
      enabled: true
      replicaCount: 1
      replicaLabels:
        - replica
      dnsDiscovery:
        sidecarsService: kube-prometheus-stack-thanos-discovery
        sidecarsNamespace: monitoring
      ingress:
        enabled: false
        hostname: "thanos.${SECRET_DOMAIN}"
        ingressClassName: "nginx"
        tls: true
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: simple-icons:prometheus
          external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"

    existingObjstoreSecret: &secret thanos-objstore

    queryFrontend:
      enabled: true
      extraFlags:
        #- --query-frontend.log-queries-longer-than=60s
        - |-
          --query-range.response-cache-config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": 0
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
        - |-
          --labels.response-cache-config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": 0
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
      ingress:
        enabled: true
        hostname: "thanos.${SECRET_DOMAIN}"
        ingressClassName: "nginx"
        tls: true
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: simple-icons:prometheus
          external-dns.alpha.kubernetes.io/target: "ingress.${SECRET_DOMAIN}"

    bucketweb:
      enabled: true
      replicaCount: 1
      podAnnotations:
        secret.reloader.stakater.com/reload: *secret

    compactor:
      enabled: true
      retentionResolutionRaw: 14d
      retentionResolution5m: 14d
      retentionResolution1h: 14d
      consistencyDelay: 30m
      compact.concurrency: 6
      downsample.concurrency: 6
      block-sync-concurrency: 60
      persistence:
        enabled: true
        size: 10Gi
        storageClass: "local-path"
      podAnnotations:
        secret.reloader.stakater.com/reload: *secret
      nodeSelector:
        kubernetes.io/arch: amd64

    storegateway:
      enabled: true
      extraFlags:
        - |-
          --index-cache.config="config":
            "addr": "redis-headless.datahub.svc.cluster.local:26379"
            "username": ""
            "password": ""
            "db": 1
            "dial_timeout": "5s"
            "read_timeout": "3s"
            "write_timeout": "3s"
            "max_get_multi_concurrency": 100
            "get_multi_batch_size": 100
            "max_set_multi_concurrency": 100
            "set_multi_batch_size": 100
            "tls_enabled": false
            "cache_size": "125MB"
            "expiration": "24h0m0s"
            "master_name": "redis-master"
          "type": "redis"
      replicaCount: 1
      podAntiAffinityPreset: hard
      persistence:
        enabled: true
        storageClass: local-path
        size: 5Gi
  #sharded:
  #  enabled: true
  #  hashPartitioning:
  #    shards: 3
    #timePartitioning:
    #  - min: ""
    #    max: ""
    #service:
    #  clusterIPs: []
    #  loadBalancerIPs: []
    #  http:
    #    nodePorts: []
    #  grpc:
    #    nodePorts: []


      podAnnotations:
        secret.reloader.stakater.com/reload: *secret
      nodeSelector:
        kubernetes.io/arch: amd64


    metrics:
      enabled: false
      serviceMonitor:
        enabled: false
