---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: harbor
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: harbor
      version: 1.11.1
      sourceRef:
        kind: HelmRepository
        name: harbor
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  #postRenderers:
  #  - kustomize:
  #      patchesJson6902:
  #        - target:
  #            kind: Service
  #            name: harbor
  #          patch:
  #            - op: add
  #              path: /spec/externalIPs
  #              value: ["${SECRET_EXTERNAL_IP}"]
  #            - op: remove
  #              path: /spec/loadBalancerIP
  values:
    expose:
      ingress:
        hosts:
          core: harbor.${SECRET_DOMAIN}
          notary: notary.${SECRET_DOMAIN}
        className: nginx
        annotations:
          hajimari.io/icon: simple-icons:harbor
          hajimari.io/enable: "true"
        tls:
          certSource: secret
          secretName: harbor-tls-certificate
          notarySecretName: notary-tls-certificate


    ipFamily:
      ipv6:
        enabled: false

    persistence:
      enabled: true
      persistentVolumeClaim:
        registry:
          existingClaim: harbor-registry-v1
          storageClass: longhorn
          subPath: registry
        chartmuseum:
          existingClaim: harbor-registry-v1
          storageClass: longhorn
          subPath: chartmuseum

    harborAdminPassword: "${HARBOR_ADMIN_PASSWORD}"
    # The secret key used for encryption. Must be a string of 16 chars.
    secretKey: "${HARBOR_ENCRPYTION_KEY}"

    notary:
      enabled: true

    #nginx:
    #  podAnnotations:
    #    secret.reloader.stakater.com/reload: tls.harbor

  valuesFrom:
    - targetPath: harborAdminPassword
      kind: Secret
      name: harbor
      valuesKey: harborAdminPassword
    - targetPath: secretKey
      kind: Secret
      name: harbor
      valuesKey: haborEncryptionKey
