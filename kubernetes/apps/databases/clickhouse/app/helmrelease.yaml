---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: clickhouse
  namespace: databases
spec:
  interval: 15m
  chart:
    spec:
      chart: clickhouse
      version: 3.1.2
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    disableWait: true
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:

    image:
      registry: docker.io
      repository: bitnami/clickhouse
      tag: 23.2.4-debian-11-r0

    replicaCount: 1
    shards: 1

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        #cpu: 1000m
        memory: 1024Mi

    nodeSelector:
      kubernetes.io/arch: amd64

    ingress:
      enabled: false
      ClassName: nginx
      annotations:
        hajimari.io/appName: "clickhouse"
        hajimari.io/enable: "true"
        hajimari.io/icon: "alarm-light-outline"
      hosts:
        - host: clickhouse.devfu.io
          paths:
            - path: /play
              pathType: Prefix
              backend:
                service:
                  name: clickhouse
                  port:
                    number: 8123
      tls:
        - hosts:
            - clickhouse.devfu.io
          secretName: clickhouse-tls


    persistence:
      enabled: true
      size: 10Gi
      storageClass: "local-path"
      accessModes:
        - ReadWriteOnce


    auth:
      username: admin
      existingSecret: "clickhouse-credentials"
      existingSecretKey: "CLICKHOUSE_PASSWORD"

    zookeeper:
      replicasCount: 1
