---
sources:

  k3s_monitoring_src:
    type: redis
    url: redis://redis-master.logging.svc.cluster.local:6379/0
    key: "k3s_prod:monitoring"

transforms:

  kubernetes_remap:
    type: remap
    inputs:
      - k3s_monitoring_src
    source: |
      # Standardize 'app' index
      .app_name = .pod_labels."app.kubernetes.io/name" || .pod_labels.app || .pod_labels."k8s-app" || "unknown"

  filter_loki:
    type: filter
    inputs:
      - kubernetes_remap
    condition: |
      .app_name == "event-exporter"



sinks:


  #kubernetes_loki:
  #  type: loki
  #  batch:
  #    max_bytes: 2049000
  #  labels:
  #    app: event-exporter
  #    environment: production
  #  encoding:
  #    codec: json
  #  endpoint: http://loki.logging.svc.cluster.local:3100
  #  inputs:
  #    - filter_pod_event-exporter
  #  out_of_order_action: accept
  #  remove_label_fields: true
  #  remove_timestamp: true

  stdout:
    type: console
    encoding:
      codec: "text"
    inputs:
      - k3s_monitoring_src

  elasticsearch:
    type: elasticsearch
    inputs:
      - k3s_monitoring_src
    auth:
      strategy: "basic"
      user: "ingestion"
      password: "monitor" # local temporal user for testing
    data_stream:
      # {data_stream.type}-{data_stream.dataset}-{data_stream.namespace}
      # https://www.elastic.co/guide/en/ecs/master/ecs-data_stream.html
      type: logs
      dataset: "k3s_prod"
      namespace: monitoring
    mode: "data_stream"
    bulk:
      action: "create"
    endpoints:
      - "https://elastic.devfu.io"
    tls:
      verify_certificate: false
