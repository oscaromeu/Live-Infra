apiVersion: beat.k8s.elastic.co/v1beta1
kind: Beat
metadata:
  name: metricbeat
spec:
  type: metricbeat
  version: 8.8.0
  elasticsearchRef:
    name: elk
  #kibanaRef:
  #  name: kibana
  config:
    metricbeat:
      autodiscover:
        providers:
        - hints:
            default_config: {}
            enabled: "true"
          node: ${NODE_NAME}
          type: kubernetes
      modules:
        - module: elasticsearch
          xpack.enabled: true
          period: 10s
          hosts: ["https://elk-es-http.logging.svc.cluster.local:9200"]
      #- module: system
      #  period: 10s
      #  metricsets:
      #  - cpu
      #  - load
      #  - memory
      #  - network
      #  - process
      #  - process_summary
      #  process:
      #    include_top_n:
      #      by_cpu: 5
      #      by_memory: 5
      #  processes:
      #  - .*
      #- module: system
      #  period: 1m
      #  metricsets:
      #  - filesystem
      #  - fsstat
      #  processors:
      #  - drop_event:
      #      when:
      #        regexp:
      #          system:
      #            filesystem:
      #              mount_point: ^/(sys|cgroup|proc|dev|etc|host|lib)($|/)
      #- module: kubernetes
      #  period: 10s
      #  node: ${NODE_NAME}
      #  hosts:
      #  - https://${NODE_NAME}:10250
      #  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      #  ssl:
      #    verification_mode: none
      #  metricsets:
      #  - node
      #  - system
      #  - pod
      #  - container
      #  - volume

      #- module: prometheus
      #  period: 60s
      #  hosts: ["kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090"]
      #  ssl.verification_mode: "none"
      #  fields:
      #    metricset.module: elasticsearch-capacity-planning
      #  metricsets: ["query"]
      #  queries:

          #- name: 'elasticsearch_cluster_health_active_primary_shards'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum by (cluster) (elasticsearch_cluster_health_active_primary_shards{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_cluster_health_active_shards'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum by (cluster) (elasticsearch_cluster_health_active_shards{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_cluster_health_number_of_data_nodes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "round(sum(elasticsearch_indices_store_size_bytes{job='prometheus-elasticsearch-exporter'} / 1024 / 1024 / 1024), 0.1)"
#
          #- name: 'elasticsearch_cluster_health_number_of_data_nodes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum by (cluster) (elasticsearch_cluster_health_number_of_data_nodes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_cluster_health_number_of_nodes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum by (cluster) (elasticsearch_cluster_health_number_of_data_nodes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_filesystem_data_available_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum by (cluster) (elasticsearch_filesystem_data_available_bytes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_filesystem_data_free_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_filesystem_data_free_bytes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_filesystem_data_size_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_filesystem_data_size_bytes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_docs'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_docs{job=\"prometheus-elasticsearch-exporter\"})"
#
#
          #- name: 'elasticsearch_indices_deleted_docs_primary'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_deleted_docs_primary{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_docs_primary'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_docs_primary{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_docs_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_docs_total{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_indexing_delete_time_seconds_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (elasticsearch_indices_indexing_delete_time_seconds_total{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_indexing_delete_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_indexing_delete_time_seconds_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_index_current'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_index_current{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_indexing_index_time_seconds_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_indexing_index_time_seconds_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_indexing_index_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_indexing_index_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_query_cache_cache_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_query_cache_cache_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_query_cache_cache_size'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_query_cache_cache_size{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_query_cache_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_query_cache_count{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_query_cache_memory_size_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_query_cache_memory_size_bytes{job=\"prometheus-elasticsearch-exporter\"})"
#
          #- name: 'elasticsearch_indices_query_cache_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_query_cache_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"
#
          #- name: 'elasticsearch_indices_search_fetch_time_seconds'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_search_fetch_time_seconds{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_indices_search_fetch_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_search_fetch_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_indices_search_query_time_seconds'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_search_query_time_seconds{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_indices_search_query_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_indices_search_query_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_indices_segments_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_segments_count{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_segments_memory_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_segments_memory_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_shards_docs'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_shards_docs{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_shards_docs_deleted'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_shards_docs_deleted{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_store_size_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_store_size_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_store_size_bytes_primary'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_store_size_bytes_primary{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_indices_store_size_bytes_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_indices_store_size_bytes_total{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_jvm_gc_collection_seconds_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_jvm_gc_collection_seconds_count{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_jvm_gc_collection_seconds_sum'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_jvm_gc_collection_seconds_sum{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_jvm_memory_committed_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_jvm_memory_committed_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_jvm_memory_max_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_jvm_memory_max_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_jvm_memory_used_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_jvm_memory_used_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_jvm_memory_pool_used_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_jvm_memory_pool_used_bytes{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_jvm_memory_pool_max_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_jvm_memory_pool_max_bytes{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_jvm_memory_pool_peak_used_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_jvm_memory_pool_peak_used_bytes{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_jvm_memory_pool_peak_max_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_jvm_memory_pool_peak_max_bytes{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_os_cpu_percent'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_os_cpu_percent{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_os_load1'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_os_load1{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_os_load5'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_os_load5{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_os_load15'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_os_load15{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_thread_pool_active_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_thread_pool_active_count{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_thread_pool_completed_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_thread_pool_completed_count{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_thread_pool_largest_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_thread_pool_largest_count{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_thread_pool_queue_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_thread_pool_queue_count{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_thread_pool_rejected_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_thread_pool_rejected_count{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_thread_pool_threads_count'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_thread_pool_threads_count{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_transport_rx_size_bytes_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_transport_rx_size_bytes_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_transport_tx_size_bytes_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service)  (rate(elasticsearch_transport_rx_size_bytes_total{job=\"prometheus-elasticsearch-exporter\"}[1h]))"

          #- name: 'elasticsearch_data_stream_backing_indices_total'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_data_stream_backing_indices_total{job=\"prometheus-elasticsearch-exporter\"})"

          #- name: 'elasticsearch_data_stream_store_size_bytes'
          #  path: '/api/v1/query'
          #  params:
          #    query: "sum without (container,endpoint,host,namespace,pod,job,instance,service) (elasticsearch_data_stream_store_size_bytes{job=\"prometheus-elasticsearch-exporter\"})"

    processors:
    - add_cloud_metadata: {}
    - add_host_metadata: {}

  daemonSet:
    podTemplate:
      spec:
        serviceAccountName: metricbeat
        automountServiceAccountToken: true # some older Beat versions are depending on this settings presence in k8s context
        containers:
        - args:
          - -e
          - -c
          - /etc/beat.yml
          - -system.hostfs=/hostfs
          name: metricbeat
          volumeMounts:
          - mountPath: /hostfs/sys/fs/cgroup
            name: cgroup
          - mountPath: /var/run/docker.sock
            name: dockersock
          - mountPath: /hostfs/proc
            name: proc
          env:
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
        dnsPolicy: ClusterFirstWithHostNet
        hostNetwork: true # Allows to provide richer host metadata
        securityContext:
          runAsUser: 0
        terminationGracePeriodSeconds: 30
        volumes:
        - hostPath:
            path: /sys/fs/cgroup
          name: cgroup
        - hostPath:
            path: /var/run/docker.sock
          name: dockersock
        - hostPath:
            path: /proc
          name: proc
