---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: telegraf
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: telegraf
      version: 1.8.28
      sourceRef:
        kind: HelmRepository
        name: influxdata
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: true
    remediation:
      retries: 5

  upgrade:
    remediation:
      retries: 5

  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
    - name: ingress-nginx
      namespace: networking
#    - name: rook-ceph
#      namespace: rook-ceph

  values:

    volumes:
    - name: telegraf-config
      configMap:
        name: "telegraf-config"
    mountPoints:
    - name: telegraf-config
      mountPath: /etc/telegraf/conf.d
      subPath: stackdriver.conf

    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 128Mi
        #cpu: 100m
    outputs:
      - influxdb:
          urls:
            - "http://<victoriametrics-addr>:8428"
    inputs:
      - statsd:
          service_address: ":8125"
          percentiles:
            - 50
            - 95
            - 99
          metric_separator: "_"
          allowed_pending_messages: 10000
          percentile_limit: 1000

