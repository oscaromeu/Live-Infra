---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app vector-aggregator
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://helm.vector.dev
      chart: vector
      version: 0.19.0
      sourceRef:
        kind: HelmRepository
        name: vector
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:

    args: ["--config", "/etc/vector/vector.yaml"]

    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        memory: 256Mi

    customConfig:
      data_dir: /vector-data-dir

    extraVolumes:
      - name: vector-config
        configMap:
          name: vector-aggregator-configmap
    extraVolumeMounts:
      - name: vector-config
        mountPath: /etc/vector/vector.yaml
        subPath: vector.yaml
        readOnly: true
    #  data:
    #    enabled: true
    #    type: emptyDir
    #    mountPath: /vector-data-dir

    persistence:
      enabled: true
      accessModes:
        - ReadWriteOnce
      size: 1Gi
      storageClass: longhorn

    podMonitor:
      enabled: true
