---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wikijs
  namespace: tools
spec:
  interval: 5m
  chart:
    spec:
      chart: wiki
      version: 2.2.20
      sourceRef:
        kind: HelmRepository
        name: requarks
        namespace: flux-system
      interval: 5m
  values:
    replicaCount: 2
    revisionHistoryLimit: 10
    image:
      repository: requarks/wiki
      imagePullPolicy: IfNotPresent

    #imagePullSecrets: []
    #nameOverride: ""
    #fullnameOverride: ""

    serviceAccount:
      create: true
      annotations: {}
      name: wikijs-home-ops

    livenessProbe:
      httpGet:
        path: /healthz
        port: http

    readinessProbe:
      httpGet:
        path: /healthz
        port: http

    startupProbe:
      initialDelaySeconds: 15
      periodSeconds: 5
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 60
      httpGet:
        path: /healthz
        port: http

    podSecurityContext: {}
      # fsGroup: 2000

    securityContext: {}
      # capabilities:
      #   drop:
      #   - ALL
      # readOnlyRootFilesystem: true
      # runAsNonRoot: true
      # runAsUser: 1000

    service:
      type: ClusterIP
      port: 80

    ingress:
      enabled: true
      className: external
      annotations:
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hajimari.io/icon: pajamas:gitea
      hosts:
        - host: &host wiki.${SECRET_DOMAIN}
          paths:
            - path: "/"
              pathType: Prefix
      tls:
        - hosts:
            - *host

    resources:
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi

    sideload:
      enabled: true
      # Git-Repo containing all locales.json-files you need:
      repoURL: https://github.com/Requarks/wiki-localization

## This will override the postgresql chart values
# externalPostgresql:
#   # note: ?sslmode=require => ?ssl=true
#   databaseURL: postgresql://postgres:postgres@postgres:5432/wiki?ssl=true
#   # For self signed CAs, like DigitalOcean
#   NODE_TLS_REJECT_UNAUTHORIZED: "0"

postgresql:
  enabled: true
  postgresqlUser: postgres
  postgresqlDatabase: wiki
  replication:
    enabled: false
  persistence:
    enabled: true
    storageClass: "local-path"
    accessMode: ReadWriteOnce
    size: 8Gi
