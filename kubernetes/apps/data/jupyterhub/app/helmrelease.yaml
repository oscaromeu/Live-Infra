---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app jupyterhub
  namespace: data
spec:
  interval: 15m
  chart:
    spec:
      chart: jupyterhub
      version: 2.0.0
      sourceRef:
        kind: HelmRepository
        name: jupyterhub
        namespace: flux-system
  install:
    disableWait: true
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    disableWait: true
    remediation:
      retries: 3
  values:

    hub:
      authenticatePrometheus: false
      nodeSelector:
        kubernetes.io/os: amd64
      db:
        pvc:
          storageClassName: longhorn
      resources:
        requests:
          cpu: 0.5
          memory: 1G
        limits:
          #cpu: 1
          memory: 2G

    #proxy:



    singleuser:
      extraNodeAffinity:
        required:
          - matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                  - amd64
                  - i386
                  - i686
                  - x86

      storage:
        type: dynamic
        capacity: 3Gi
        dynamic:
          storageClass: longhorn
      cpu:
        guarantee: 0.5
      memory:
        limit: 5G
        guarantee: 0.5G

    scheduling:
      userScheduler:
        enabled: true
        nodeSelector:
          kubernetes.io/os: amd64
        resources:
          requests:
            cpu: 1m
            memory: 100M
          limits:
            #cpu: 1
            memory: 200M

    prePuller:
      #hook:
      #  nodeSelector:
      #    kubernetes.io/os: amd64
      resources:
        requests:
          cpu: 1m
          memory: 100M
        limits:
          #cpu: 1
          memory: 200M

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-staging
        #external-dns.alpha.kubernetes.io/target: "ipv4.${SECRET_DOMAIN}"
        external-dns.home.arpa/enabled: "true"
        hajimari.io/icon: video-input-antenna
      hosts:
        - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host
          secretName: "{{ .Release.Name }}-tls"

