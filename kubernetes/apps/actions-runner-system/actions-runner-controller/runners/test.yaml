---
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerSet
metadata:
  name: self-hosted-cache
spec:
  replicas: 1
  repository: oscaromeu/fastapi-observability
  labels: ["self-hosted-cache"]
  #dockerdWithinRunnerContainer: true
  selector:
    matchLabels:
      app: self-hosted-cache
  serviceName: self-hosted-cache
  template:
    #image: summerwind/actions-runner-dind:latest
    metadata:
      labels:
        app: self-hosted-cache
    spec:
      containers:
        - name: runner
          env:
            - name: DOCKER_ENABLED
              value: "true"
            - name: DOCKERD_IN_RUNNER
              value: "false"
            - name: DOCKER_HOST
              value: unix:///run/docker.sock
          volumeMounts:
            - name: var-lib-docker
              mountPath: /var/lib/docker
          image: summerwind/actions-runner:latest
          resources:
            {}
            #limits:
            #  #cpu: "4.0"
            #  memory: "8Gi"
            #requests:
            #  cpu: "2.0"
            #  memory: "4Gi"
        - name: docker
          args:
            - dockerd
            - --host=unix:///run/docker.sock
            - --group=$(DOCKER_GROUP_GID)
          env:
            - name: DOCKER_GROUP_GID
              value: "1001"
          image: docker:dind
          resources:
            {}
            #limits:
            #  #cpu: "4.0"
            #  memory: "8Gi"
            #requests:
            #  cpu: "2.0"
            #  memory: "4Gi"
  volumeClaimTemplates:
    - metadata:
        name: var-lib-docker
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 3Gi
        storageClassName: local-path
