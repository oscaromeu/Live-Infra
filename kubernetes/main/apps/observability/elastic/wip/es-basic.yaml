---
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  #annotations:
  #  eck.k8s.elastic.co/downward-node-labels: "topology.kubernetes.io/zone"
  name: elk
spec:
  version: 8.14.3
  nodeSets:
  - name: default
    config:
      logger.level: info
      node.roles: ["master", "data", "ingest", "ml"]
      node.store.allow_mmap: false
      xpack.monitoring.collection.enabled: true
      xpack.monitoring.elasticsearch.collection.enabled: true
      xpack.monitoring.collection.cluster.stats.timeout: "10m"
      xpack.monitoring.collection.index.recovery.active_only: "false"
      xpack.monitoring.collection.index.recovery.timeout: "10m"
      xpack.monitoring.collection.index.stats.timeout: "10m"
      xpack.monitoring.collection.indices: "'*'"
      xpack.monitoring.collection.interval: "60s"
      xpack.monitoring.history.duration: "7d"
      # uncomment the lines below to use the zone attribute from the node labels
      #cluster.routing.allocation.awareness.attributes: k8s_node_name,zone
      #node.attr.zone: ${ZONE}
    podTemplate:
      metadata:
        labels:
          stack-monitoring.elastic.co/type: es
          app.kubernetes.io/name: elk
          app.kubernetes.io/service: analytics
          app.kubernetes.io/component: elasticsearch
      spec:
        # this changes the kernel setting on the node to allow ES to use mmap
        # if you uncomment this init container you will likely also want to remove the
        # "node.store.allow_mmap: false" setting above
        # initContainers:
        # - name: sysctl
        #   securityContext:
        #     privileged: true
        #     runAsUser: 0
        #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
        ###
        # uncomment the line below if you are using a service mesh such as linkerd2 that uses service account tokens for pod identification.
        # automountServiceAccountToken: true
        containers:
        - name: elasticsearch
          resources:
            requests:
              memory: 7Gi
              cpu: 241m
            limits:
              memory: 7Gi
          env:
            - name: ES_JAVA_OPTS
              value: "-Xms3g -Xmx3g"
            - name: READINESS_PROBE_TIMEOUT
              value: "10"
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                elasticsearch.k8s.elastic.co/cluster-name: elk
                elasticsearch.k8s.elastic.co/statefulset-name: elk-es-default
    count: 3
    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        storageClassName: openebs-hostpath
  monitoring:
    metrics:
      elasticsearchRefs:
        - name: elk
    logs:
      elasticsearchRefs:
        - name: elk
